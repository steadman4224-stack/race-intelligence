<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RacePad</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
      color: #111;
    }

    body.dark {
      background: #121212;
      color: #eee;
    }

    header {
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #222;
      color: white;
    }

    select, input[type=file], button {
      margin: 6px;
      padding: 6px;
      font-size: 14px;
    }

    .card {
      background: white;
      margin: 8px;
      padding: 10px;
      border-radius: 6px;
    }

    body.dark .card {
      background: #1e1e1e;
    }

    .fast {
      color: green;
      font-weight: bold;
    }

    .slow {
      color: red;
    }

    a {
      color: inherit;
      text-decoration: none;
    }
  </style>
</head>

<body>

<header>
  <strong>ğŸ‡ RacePad</strong>
  <button onclick="toggleTheme()">ğŸŒ—</button>
</header>

<div style="padding:10px;">
  <select id="trackFilter">
    <option value="">All Tracks</option>
  </select>

  <select id="raceFilter">
    <option value="">All Races</option>
  </select>
</div>

<div style="padding:10px;">
  <input type="file" id="csvInput" accept=".csv">
  <input type="file" id="pdfInput" accept="application/pdf">
</div>

<h3 style="padding:10px;">ğŸ“„ Races</h3>
<div id="races"></div>

<h3 style="padding:10px;">ğŸ“‘ PDFs</h3>
<div id="pdfs"></div>

<script>
/* ================= CONFIG ================= */

const SUPABASE_URL = "https://jpzednbynpmcnmcpgdyp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwemVkbmJ5bnBtY25tY3BnZHlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODAzODYsImV4cCI6MjA4MTI1NjM4Nn0.3elsp_7G4_ZIa0Z2Zsq-wi8BXbSV47Z6MTS6717XfvY";

/* ================= THEME ================= */

function toggleTheme() {
  document.body.classList.toggle("dark");
}

/* ================= LOAD RACES ================= */

let raceData = [];

async function loadRaces() {
  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/race_cards?select=*`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  raceData = await res.json();
  populateFilters();
  renderRaces();
}

/* ================= FILTERS ================= */

function populateFilters() {
  const tracks = [...new Set(raceData.map(r => r.track))];
  const races = [...new Set(raceData.map(r => r.race))];

  document.getElementById("trackFilter").innerHTML =
    `<option value="">All Tracks</option>` +
    tracks.map(t => `<option>${t}</option>`).join("");

  document.getElementById("raceFilter").innerHTML =
    `<option value="">All Races</option>` +
    races.map(r => `<option>${r}</option>`).join("");
}

document.getElementById("trackFilter").onchange = renderRaces;
document.getElementById("raceFilter").onchange = renderRaces;

/* ================= RENDER ================= */

function renderRaces() {
  const track = document.getElementById("trackFilter").value;
  const race = document.getElementById("raceFilter").value;

  const filtered = raceData.filter(r =>
    (!track || r.track === track) &&
    (!race || r.race === race)
  );

  document.getElementById("races").innerHTML = filtered.map(r => `
    <div class="card">
      <strong>${r.horse}</strong><br>
      ${r.track} â€“ Race ${r.race}<br>
      Speed:
      <span class="${r.speed > r.benchmark ? 'fast' : 'slow'}">
        ${r.speed}
      </span>
      (Par ${r.benchmark})
    </div>
  `).join("");
}

/* ================= CSV UPLOAD ================= */

document.getElementById("csvInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();
  const [header, ...rows] = text.trim().split("\n");
  const cols = header.split(",");

  const records = rows.map(r => {
    const values = r.split(",");
    const obj = {};
    cols.forEach((c, i) => obj[c.trim()] = values[i]?.trim());
    return obj;
  });

  const res = await fetch(`${SUPABASE_URL}/rest/v1/race_cards`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=minimal"
    },
    body: JSON.stringify(records)
  });

  alert(res.ok ? "CSV uploaded" : "CSV upload failed");
  if (res.ok) loadRaces();
});

/* ================= PDF UPLOAD ================= */

document.getElementById("pdfInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const path = `guides/${Date.now()}-${file.name}`;

  const res = await fetch(
    `${SUPABASE_URL}/storage/v1/object/race-pdfs/${path}`,
    {
      method: "POST",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/pdf"
      },
      body: file
    }
  );

  alert(res.ok ? "PDF uploaded" : "PDF upload failed");
  if (res.ok) loadPDFs();
});

/* ================= LOAD PDFs ================= */

async function loadPDFs() {
  const res = await fetch(
    `${SUPABASE_URL}/storage/v1/object/list/race-pdfs`,
    {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    }
  );

  const files = await res.json();

  document.getElementById("pdfs").innerHTML = files.map(f => `
    <div class="card">
      <a target="_blank"
         href="${SUPABASE_URL}/storage/v1/object/public/race-pdfs/${f.name}">
        ğŸ“„ ${f.name}
      </a>
    </div>
  `).join("");
}

/* ================= INIT ================= */

loadRaces();
loadPDFs();
</script>

</body>
</html>
